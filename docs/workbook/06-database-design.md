[🌐 EN VERSION](06-database-design_EN.md)

# [06] 저장소 구조(Database) 설계: SQLite 영구화 전략

대규모 기업용 소프트웨어가 아닌 개인/단기 프로젝트라 해도, 데이터의 동시성과 무결성은 언제나 고민거리입니다. 

BCC는 기존의 순수 JSON 파일 전면 덮어쓰기 방식을 버리고, 가볍지만 관계형 연결의 강력함을 자랑하는 **SQLite Database (`data/faces.db`)** 인프라를 채택했습니다.

## 1. SQLite 기반 파일 저장소 전략의 이점
시스템이 실행되면 파이썬 백엔드는 시작과 동시에 `/data/faces.db` 파일에 접속 커넥션을 형성합니다. 이때 RDBMS 엔진을 따로 띄울 필요 없이 파이썬 내장 모듈만으로 모든 게 동작합니다.

- **안전한 동시성 (Concurrency)**: 이전 JSON 방식에서는 다수의 쓰레드가 동시에 읽고 쓸 때 파일이 깨질 위험이 있었습니다. SQLite는 자체 Lock 매커니즘을 지원하여 병렬 데이터 I/O 에서도 얼굴의 영구 보존(Persistence)을 보장합니다.
- **구조적 스키마 (Schema)**: 
  - `id`: 자동 증가 Primary Key
  - `name`: 등록 타겟의 고유 식별자 단어 (UNIQUE 옵션으로 중복 등록 자동 회피 - Upsert 처리)
  - `embedding`: 512차원의 InsightFace 배열 데이터를 JSON 포맷 문자열로 변환(stringify) 하여 손실 없이 담아둡니다.
- **투명하지만 강력한 디버깅**: 개발자가 언제든 DataGrip, DBeaver 같은 DB 툴이나 `sqlite3` CLI 명령어를 통해 데이터를 안전하게 시각적 검증 및 수정/삭제 할 수 있습니다.

## 2. 매칭 프로세스 최적화 전략
카메라에 새로운 사람이 나타날 때마다 `faces.db` 파일에서 데이터를 꺼내 읽으면 디스크 I/O가 발생해 카메라 프레임에 랙이 생길 수 있습니다.

이를 위해 BCC는 **SQLite에서 데이터를 가져온 뒤, RAM 메모리에 딕셔너리 형태로 캐시해두고 루핑(for-loop)하며 비교하는 방식**을 채택했습니다. (속도 + 무결성 둘 다 취하는 하이브리드 전략)

이처럼 단일 파일 기반의 초경량 DB인 SQLite 덕분에 도커(Docker)나 별도 서버 환경 구축 하나 없이 완전 독립형 실행(Standalone Deployment)이 가능해졌습니다.
