[🌐 EN VERSION](04-backend-stack_EN.md)

# [04] 백엔드 심화 해부: 스레딩과 모델 엔진

왜 파이썬(Flask)을 메인 서버로 채택했을까요?
이는 지구상에서 머신러닝/AI 진영 컴포넌트(InsightFace, OpenCV, PyTorch 등)의 대다수가 Python으로 구현되어 생태계가 집중되어 있기 때문입니다.

## 1. 딜레마: GIL (Global Interpreter Lock) 과 스레딩
웹 서버(Flask)가 요청을 받는 스레드와 InsightFace가 이미지를 처리하는 스레드가 동일하면 서버가 멈춰버립니다. 모델 분석에 0.1초가 걸린다면 프레임은 고작 10 FPS로 뚝 떨어질 것입니다.

대응책:
1. **메인 카메라 스레드**: OpenCV는 순수하게 이미지를 가져오고 JPEG로 인코딩하는 데만 집중합니다. (지연 시간 0.01초 이하로 최소 30 FPS 방어)
2. **AI 분석 일꾼 스레드 (Worker)**: 가장 최신 사진을 복사해간 다음 천천히 분석합니다. 메인 비디오 스트림과 완전히 분리되어 비디오가 버벅거리지 않게 만듭니다.

## 2. 매칭 알고리즘: 코사인 유사도 (Cosine Similarity)
AI 엔진(ArcFace)은 특정한 사람의 얼굴을 512개의 소수점으로 된 1차원 배열(Vector)로 바꿉니다.
새로운 얼굴 벡터 A와 저장된 원본 벡터 B가 동일 인물인지 판별할 때 어떻게 해야 할까요?

단순 숫자 빼기(유클리디언 거리)보다 **벡터의 각도 차이**를 구하는 코사인 유사도가 가장 강력한 기법입니다. (안경 착용, 조명 변화 등에 매우 강건합니다.)
- 로직 체인: `A · B / (||A|| * ||B||)`
- BCC 프로젝트의 기준 `Threshold`: 유사도가 약 **0.4** 이상이면 동일 인물로 간주하여 HUD 에 녹색 불빛(IDENTIFIED)과 이름을 띄우게 세팅되어 있습니다. 그 이하라면 UNKNOWN (위험 인물 타겟) 상태가 됩니다.

이 모든 수식이 `model_manager.py` 안에서 계산됩니다.
